<!doctype html>

<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Add / Spend Balance — Lenden</title>
  <style>
    /* Theme variables (from user) */
:root {
  --bg: #0b1020;
  --card: #141a2f;
  --muted: #8aa0ff;
  --text: #e8ecff;
  --accent: #4f7cff;
  --danger: #ff647c;
  --success: #2ecc71;
  --warning: #ffb020;
  --border: #2a3154;
  --soft: #1b2240;
}
body.light {
  --bg: #f0f4f9;
  --card: #ffffff;
  --muted: #253d77;
  --text: #1a4092;
  --accent: #346aff;
  --danger: #e53e3e;
  --success: #38a169;
  --warning: #d69e2e;
  --border: #e2e8f0;
  --soft: #f8fafc;
}
  
  html, body {
  height: 100%;
}

body {
  margin: 0;
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  background: linear-gradient(180deg, var(--bg), #07101a);
  color: var(--text);
  -webkit-font-smoothing: antialiased;
  padding: 18px;
}

.container {
  max-width: 980px;
  margin: 0 auto;
  text-align: center;
}
  
  
  .wallet {
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
  padding: 18px;
  border-radius: 14px;
  box-shadow: 0 6px 18px rgba(0, 0, 0, 0.35);
  border: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
}

.wallet .title {
  font-size: 14px;
  color: var(--muted);
}

.wallet .amount {
  font-size: 50px;
  font-weight: 700;
}

.btn {
  padding: 10px 14px;
  border-radius: 12px;
  border: none;
  background: var(--accent);
  color: var(--text);
  cursor: pointer;
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
  font-weight: 600;
}

.btn.ghost {
  background: transparent;
  border: 1px solid var(--border);
}

.btn.danger {
  background: linear-gradient(90deg, var(--danger), #ff4a6b);
}

.hidden {
  display: none;
}

  .form-panel {
  margin-top: 12px;
  background: var(--card);
  padding: 12px;
  border-radius: 12px;
  border: 1px solid var(--border);
}

.form-row {
  display: flex;
  gap: 10px;
  align-items: center;
  margin-bottom: 10px;
  flex-wrap: wrap;
  justify-content: center;
}

.select,
input[type=number] {
  padding: 10px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text);
  min-width: 180px;
}

.input-amount {
  flex: 1;
  min-width: 120px;
}

  
  .history {
  margin-top: 16px;
  background: var(--card);
  padding: 12px;
  border-radius: 12px;
  border: 1px solid var(--border);
}

.table {
  width: 100%;
  border-collapse: collapse;
}

.table th,
.table td {
  padding: 8px 6px;
  text-align: left;
  font-size: 14px;
  border-bottom: 1px dashed rgba(255, 255, 255, 0.03);
}

.table th {
  font-weight: 700;
  color: var(--muted);
}

.row-add {
  color: var(--success);
  font-weight: 700;
}

.row-spend {
  color: var(--danger);
  font-weight: 700;
}

.summary {
  margin-top: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-top: 8px;
  color: var(--muted);
  flex-wrap: wrap;
}

.small {
  font-size: 13px;
  color: var(--muted);
}

  
  /* Tiny spinner */
.spinner {
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 2px solid rgba(255, 255, 255, 0.12);
  border-top-color: var(--text);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  vertical-align: middle;
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

  
  @media (max-width: 640px) {
  .wallet .amount {
    font-size: 40px;
  }
  .form-row {
    flex-direction: column;
    align-items: stretch;
  }
  .summary {
    flex-direction: column;
    gap: 6px;
    align-items: flex-start;
  }
}

  

  </style>
</head>
<body>
  <div class="container">
    <div class="wallet" role="region" aria-label="wallet-summary">
      <div class="title">Total Wallet Balance</div>
      <div class="amount" id="totalBalance">৳ 0</div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:center">
        <button id="btnAdd" class="btn">টাকা যোগ</button>
        <button id="btnSpend" class="btn danger">খরচ করুন</button>
      </div>
    </div><div id="actionPanel" class="form-panel hidden" aria-hidden="true">
  <div class="form-row">
    <select id="selectAccount" class="select"></select>
  </div>
  <div class="form-row">
    <input id="amountInput" class="input-amount" type="number" min="0" step="0.01" placeholder="পরিমাণ (৳)" />
  </div>
  <div class="form-row">
    <button id="submitBtn" class="btn">যোগ করুন</button>
    <button id="cancelBtn" class="btn ghost">Cancel</button>
  </div>
</div>

<div class="history">
  <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:10px">
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <input style="background-color: #253d77; border-radius: 10px" type="date" id="fromDate" />
      <input style="background-color: #253d77; border-radius: 10px" type="date" id="toDate" />
      <button id="applyFilter" class="btn ghost">Apply</button>
      <button id="clearFilter" class="btn ghost">Clear</button>
    </div>
    <div class="small">মোট <span id="countShown">0</span>টি হিস্টরি রয়েছে</div>
  </div>
  <table class="table" id="historyTable">
    <thead>
      <tr><th>তারিখ</th>
      <th>একাউন্ট</th>
        <th>ধরন</th>
        <th>পরিমান</th>
        <th>আগের</th>
        <th></th></tr>
    </thead>
    <tbody id="historyBody"></tbody>
  </table>
  <div class="summary" id="historySummary">
    <div class="small">মোট লেনদেন: <span id="totalItems">0</span></div>
    <div class="small">নেট চার্য: <span id="netChange">৳ 0</span></div>
  </div>
</div>

  </div>  <!-- Firebase scripts + user-provided config -->  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
  import { getDatabase, ref, onValue, get, set, push } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB_84BFLI-5iMOTwDUepXKUmDQgK4csZFk",
    authDomain: "lenden-d2bc9.firebaseapp.com",
    databaseURL: "https://lenden-d2bc9-default-rtdb.firebaseio.com",
    projectId: "lenden-d2bc9",
    storageBucket: "lenden-d2bc9.firebasestorage.app",
    messagingSenderId: "258159170143",
    appId: "1:258159170143:web:97e3f7acaa6d2fdaa001ea",
    measurementId: "G-V6TRPK7XET"
  };
  const app = initializeApp(firebaseConfig);
  try{ getAnalytics(app); }catch(e){}
  const db = getDatabase(app);

  // Elements
  const totalBalanceEl = document.getElementById('totalBalance');
  const btnAdd = document.getElementById('btnAdd');
  const btnSpend = document.getElementById('btnSpend');
  const actionPanel = document.getElementById('actionPanel');
  const selectAccount = document.getElementById('selectAccount');
  const amountInput = document.getElementById('amountInput');
  const submitBtn = document.getElementById('submitBtn');
  const cancelBtn = document.getElementById('cancelBtn');
  const historyBody = document.getElementById('historyBody');
  const totalItemsEl = document.getElementById('totalItems');
  const netChangeEl = document.getElementById('netChange');
  const countShown = document.getElementById('countShown');
  const fromDate = document.getElementById('fromDate');
  const toDate = document.getElementById('toDate');
  const applyFilter = document.getElementById('applyFilter');
  const clearFilter = document.getElementById('clearFilter');

  let mode = 'add';
  let accounts = {}; 
  let historyList = [];

  function formatCurrency(n){
    const v = Number(n||0);
    return '৳ ' + v.toLocaleString(undefined,{minimumFractionDigits: (v % 1 ? 2:0)})
  }
  function todayDdMmYyyy(){
    const d=new Date();
    const dd=String(d.getDate()).padStart(2,'0');
    const mm=String(d.getMonth()+1).padStart(2,'0');
    const yyyy=d.getFullYear();
    return `${dd}/${mm}/${yyyy}`;
  }
  function parseDdMmYyyyToDate(s){
    if(!s) return null;
    const parts=s.split('/');
    if(parts.length!==3) return null;
    const dd=parseInt(parts[0],10), mm=parseInt(parts[1],10)-1, yy=parseInt(parts[2],10);
    return new Date(yy,mm,dd);
  }

  function populateAccounts(snapshotVal){
    accounts = snapshotVal || {};
    selectAccount.innerHTML='';
    let total=0;
    Object.keys(accounts).forEach(key=>{
      const acc = accounts[key];
      const bal = parseFloat((acc && acc.Balance) || 0);
      total += isNaN(bal)?0:bal;
      const opt = document.createElement('option'); opt.value=key; opt.textContent = key + ' — ' + formatCurrency(bal);
      selectAccount.appendChild(opt);
    });
    totalBalanceEl.textContent = formatCurrency(total);
  }

  const accountsRef = ref(db,'Account');
  onValue(accountsRef, snap=>{
    const val = snap.val();
    populateAccounts(val);
  });

  const historyRef = ref(db,'history');
  onValue(historyRef, snap=>{
    const val = snap.val() || {};
    historyList = Object.keys(val).map(k=>{ return Object.assign({ _key:k }, val[k]); });
    historyList.sort((a,b)=> (b._ts||0)-(a._ts||0));
    renderHistory();
  });

  function renderHistory(){
    let from = fromDate.value ? new Date(fromDate.value) : null;
    let to = toDate.value ? new Date(toDate.value) : null;
    if(to){ to.setHours(23,59,59,999); }
    const filtered = historyList.filter(item=>{
      const d = parseDdMmYyyyToDate(item.date);
      if(!d) return true;
      if(from && d < from) return false;
      if(to && d > to) return false;
      return true;
    });
    historyBody.innerHTML='';
    let totalItems=0; let net=0;
    for(const it of filtered){
      const tr = document.createElement('tr');
      const type = it.type || (it['add balance']? 'add':'spend');
      const amount = Number(it['add balance'] || it['spend amount'] || it.amount || 0);
      const sign = type==='add' || it['add balance'] ? '+' : '-';
      const rowClass = (sign==='+') ? 'row-add' : 'row-spend';
      tr.innerHTML = `<td>${it.date||''}</td><td>${it.account||''}</td><td>${(sign==='+')?'যোগ':'খরচ'}</td><td><span class="${rowClass}">${sign} ${Math.abs(amount)}</span></td><td>${it['old balance']!=null?formatCurrency(it['old balance']):''}</td><td>${it['new balance']!=null?formatCurrency(it['new balance']):''}</td>`;
      historyBody.appendChild(tr);
      totalItems++; net += (sign==='+')? amount : -amount;
    }
    totalItemsEl.textContent = totalItems;
    countShown.textContent = totalItems;
    netChangeEl.textContent = formatCurrency(net);
  }

  btnAdd.addEventListener('click',()=>{
    mode='add'; actionPanel.classList.remove('hidden'); actionPanel.setAttribute('aria-hidden','false');
    submitBtn.textContent = 'যোগ করুন'; submitBtn.classList.remove('danger'); submitBtn.style.background='var(--accent)';
    amountInput.value='';
  });
  btnSpend.addEventListener('click',()=>{
    mode='spend'; actionPanel.classList.remove('hidden'); actionPanel.setAttribute('aria-hidden','false');
    submitBtn.textContent = 'খরচ নিশ্চিত'; submitBtn.classList.add('danger'); submitBtn.style.background='';
    amountInput.value='';
  });
  cancelBtn.addEventListener('click',()=>{ actionPanel.classList.add('hidden'); actionPanel.setAttribute('aria-hidden','true'); });

  applyFilter.addEventListener('click',()=>{ renderHistory(); });
  clearFilter.addEventListener('click',()=>{ fromDate.value=''; toDate.value=''; renderHistory(); });

  submitBtn.addEventListener('click', async ()=>{
    const acc = selectAccount.value;
    const amt = parseFloat(amountInput.value || 0);
    if(!acc){ alert('একাউন্ট সিলেক্ট করুন'); return; }
    if(!amt || amt <= 0){ alert('একটি বৈধ পরিমাণ লিখুন'); return; }
    const oldText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner"></span> প্রসেসিং...';
    try{
      const accRef = ref(db, `Account/${acc}/Balance`);
      const snap = await get(accRef);
      let oldBal = parseFloat(snap.val()||0);
      if(isNaN(oldBal)) oldBal = 0;
      let newBal;
      let historyEntry = { date: todayDdMmYyyy(), account: acc, _iso:new Date().toISOString(), _ts:Date.now() };
      if(mode==='add'){
        newBal = oldBal + amt;
        await set(accRef, newBal);
        historyEntry['add balance'] = amt;
        historyEntry['old balance'] = oldBal;
        historyEntry['new balance'] = newBal;
        historyEntry.type = 'add';
      } else {
        newBal = oldBal - amt;
        await set(accRef, newBal);
        historyEntry['spend amount'] = amt;
        historyEntry['old balance'] = oldBal;
        historyEntry['new balance'] = newBal;
        historyEntry.type = 'spend';
      }
      await push(historyRef, historyEntry);
      actionPanel.classList.add('hidden'); actionPanel.setAttribute('aria-hidden','true');
      amountInput.value='';
    }catch(err){ console.error(err); alert('Error: ' + (err.message||err)); }
    finally{ submitBtn.disabled=false; submitBtn.innerHTML = oldText; }
  });

  </script></body>
</html